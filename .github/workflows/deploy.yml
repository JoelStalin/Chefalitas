name: Deploy to Production

on:
  push:
    branches:
      - main # Este workflow se ejecuta cuando se hace push a la rama 'main'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://chefalitas.com.do/ # URL de tu instancia Odoo en producciÃ³n

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure target directory exists
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_SSH_HOST }}      # IP pÃºblica de tu servidor
          username: ${{ secrets.PROD_SSH_USER }}  # Usuario del servidor (p.ej. ubuntu)
          key: ${{ secrets.PROD_SSH_KEY }}        # Llave privada para SSH
          script: |
            mkdir -p ~/odoo18

      - name: Upload project files
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          source: .
          target: ~/odoo18

      - name: Restart services
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            set -e  # si algo falla, el step revienta

            echo ">> Entrando al directorio del proyecto"
            cd ~/odoo18

            echo ">> Directorio actual:"
            pwd

            echo ">> Listando archivos en ~/odoo18:"
            ls -la

            echo ">> Verificando que restart.sh exista:"
            ls -la restart.sh || (echo "ERROR: restart.sh NO existe en ~/odoo18" && exit 1)

            echo ">> Normalizando saltos de lÃ­nea (CRLF -> LF) en restart.sh..."
            dos2unix restart.sh || sed -i 's/\r$//' restart.sh

            echo ">> Marcando restart.sh como ejecutable..."
            chmod +x restart.sh

            echo ">> Primera lÃ­nea (shebang) de restart.sh:"
            head -n 1 restart.sh

            echo ">> Ejecutando restart.sh con bash..."
            bash ./restart.sh

            echo ">> restart.sh terminÃ³ correctamente ğŸ‰"
